<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live View</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f9f9f9;
        }

        h1 {
            margin-bottom: 20px;
        }

        .controls {
            margin: 20px;
        }

        .controls button, .controls a {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
            text-decoration: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
        }

        .chart-container {
            width: 100%; /* Charts occupy full width */
            max-width: 100%; /* Prevent horizontal scrolling */
            margin: 20px 0;
            height: 400px; /* Default height */
            transition: height 0.3s ease, width 0.3s ease; /* Smooth transitions */
        }

        .slim .chart-container {
            height: 200px; /* Slim mode height */
        }

        canvas {
            display: block;
            width: 100%; /* Canvas stretches to container width */
            height: 100%; /* Canvas fills container height */
        }
    </style>
</head>
<body>
    <h1>Live Data Visualization</h1>
    <div class="controls">
        <a href="/settings">Settings</a>
        <a href="/viewer">Viewer</a>
        <button id="pause">Pause</button>
        <button id="resume" style="display:none;">Resume</button>
        <button id="resetZoom">Reset Zoom</button>
        <a href="/save">Save to File</a>
        <button id="toggleHeight">Slim</button>
    </div>
    <div class="chart-container">
        <canvas id="mbitChart"></canvas>
    </div>
    <div class="chart-container">
        <canvas id="rssiChart"></canvas>
    </div>
    <div class="chart-container">
        <canvas id="snrChart"></canvas>
    </div>
    <div class="chart-container">
        <canvas id="redundancyChart"></canvas>
    </div>
    <div class="chart-container">
        <canvas id="derivativeChart"></canvas>
    </div>

    <script>
        let paused = false;

        const mbitCtx = document.getElementById('mbitChart').getContext('2d');
        const rssiCtx = document.getElementById('rssiChart').getContext('2d');
        const snrCtx = document.getElementById('snrChart').getContext('2d');
        const redundancyCtx = document.getElementById('redundancyChart').getContext('2d');
        const derivativeCtx = document.getElementById('derivativeChart').getContext('2d');

        const zoomOptions = {
            pan: {
                enabled: true,
                mode: 'x',
            },
            zoom: {
                wheel: {
                    enabled: true,
                },
                pinch: {
                    enabled: true,
                },
                mode: 'x',
            },
        };

        const mbitChart = new Chart(mbitCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'All Bytes (Mbit/s)', data: [], borderColor: 'red', fill: false },
                    { label: 'Out Bytes (Mbit/s)', data: [], borderColor: 'blue', fill: false },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                elements: { point: { radius: 0 } },
                scales: {
                    y: { min: 0, max: 100 }, // Default values, updated dynamically
                },
                plugins: { legend: { display: true }, zoom: zoomOptions },
            },
        });

        const rssiChart = new Chart(rssiCtx, {
            type: 'line',
            data: { labels: [], datasets: [] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                elements: { point: { radius: 0 } },
                scales: { y: { beginAtZero: true, max: 1 } },
                plugins: { legend: { display: true }, zoom: zoomOptions },
            },
        });

        const snrChart = new Chart(snrCtx, {
            type: 'line',
            data: { labels: [], datasets: [] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                elements: { point: { radius: 0 } },
                scales: { y: { beginAtZero: true, max: 1 } },
                plugins: { legend: { display: true }, zoom: zoomOptions },
            },
        });

        const redundancyChart = new Chart(redundancyCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Redundancy', data: [], borderColor: 'green', fill: false },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                elements: { point: { radius: 0 } },
                scales: { y: { beginAtZero: true, max: 6 } },
                plugins: { legend: { display: true }, zoom: zoomOptions },
            },
        });

        const derivativeChart = new Chart(derivativeCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Derivative', data: [], borderColor: 'blue', fill: false },
                    { label: 'FEC_REC', data: [], borderColor: 'purple', fill: false },
                    { label: 'LOST', data: [], borderColor: 'orange', fill: false },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                elements: { point: { radius: 0 } },
                scales: { y: { min: -2, max: 2 } },
                plugins: { legend: { display: true }, zoom: zoomOptions },
            },
        });

        function updateYAxisLimits(chart, min, max) {
            chart.options.scales.y.min = min;
            chart.options.scales.y.max = max;
            chart.update();
        }

        function fetchData() {
            if (paused) return;
            fetch('/data')
                .then((response) => response.json())
                .then((data) => {
                    const { rssi, snr, redundancy, derivative, fec_rec, lost, all_mbit, out_mbit, sample_indices, colors, settings } = data;

                    // Update Y-axis limits for Mbit/s chart
                    updateYAxisLimits(mbitChart, settings.MBIT_MIN, settings.MBIT_MAX);

                    // Update Mbit/s Chart
                    mbitChart.data.labels = sample_indices;
                    mbitChart.data.datasets[0].data = all_mbit;
                    mbitChart.data.datasets[1].data = out_mbit;
                    mbitChart.update();

                    // Update RSSI Chart
                    updateChart(rssiChart, rssi, sample_indices, colors);

                    // Update SNR Chart
                    updateChart(snrChart, snr, sample_indices, colors);

                    // Update Redundancy Chart
                    redundancyChart.data.labels = sample_indices;
                    redundancyChart.data.datasets[0].data = redundancy;
                    redundancyChart.update();

                    // Update Derivative Chart
                    derivativeChart.data.labels = sample_indices;
                    derivativeChart.data.datasets[0].data = derivative;
                    derivativeChart.data.datasets[1].data = fec_rec;
                    derivativeChart.data.datasets[2].data = lost;
                    derivativeChart.update();
                });
        }

        function updateChart(chart, data, labels, colors) {
            chart.data.labels = labels;
            chart.data.datasets = [];
            for (const [key, values] of Object.entries(data)) {
                chart.data.datasets.push({
                    label: key,
                    data: values,
                    borderColor: colors[key],
                    fill: false,
                });
            }
            chart.update();
        }

        document.getElementById('toggleHeight').addEventListener('click', () => {
            document.body.classList.toggle('slim');
            mbitChart.update();
            rssiChart.update();
            snrChart.update();
            redundancyChart.update();
            derivativeChart.update();
            document.getElementById('toggleHeight').textContent = document.body.classList.contains('slim') ? 'Normal' : 'Slim';
        });

        document.getElementById('pause').addEventListener('click', () => {
            paused = true;
            document.getElementById('pause').style.display = 'none';
            document.getElementById('resume').style.display = 'inline';
        });

        document.getElementById('resume').addEventListener('click', () => {
            paused = false;
            document.getElementById('resume').style.display = 'none';
            document.getElementById('pause').style.display = 'inline';
        });

        document.getElementById('resetZoom').addEventListener('click', () => {
            mbitChart.resetZoom();
            rssiChart.resetZoom();
            snrChart.resetZoom();
            redundancyChart.resetZoom();
            derivativeChart.resetZoom();
        });

        setInterval(fetchData, 500);
    </script>



    <head>
  <meta charset="utf-8"/>
  <title>File Browser</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      margin-bottom: 0.5rem;
    }
    #filesContainer {
      margin-top: 1rem;
    }
    table {
      border-collapse: collapse;
      width: 80%;
      max-width: 800px;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 8px 12px;
      text-align: left;
    }
    th {
      background-color: #f0f0f0;
    }
    button {
      margin: 2px;
      padding: 4px 8px;
      cursor: pointer;
    }
    #refreshBtn {
      margin-bottom: 1rem;
    }
    #statusMessage {
      color: #444;
      margin-top: 1rem;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h1>File Browser</h1>
  <p>Manage files in the configured directory on the server.</p>

  <button id="refreshBtn">Refresh File List</button>

  <div id="filesContainer">
    <!-- File table or message will be inserted here by JavaScript -->
  </div>

  <div id="statusMessage"></div>

  <script>
    const filesContainer = document.getElementById('filesContainer');
    const statusMessage = document.getElementById('statusMessage');
    const refreshBtn = document.getElementById('refreshBtn');

    refreshBtn.addEventListener('click', () => {
      loadFiles();
    });

    // Load file list from the server
    function loadFiles() {
      statusMessage.textContent = "Loading files...";
      fetch('/files')
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            filesContainer.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
            statusMessage.textContent = "";
            return;
          }

          renderFiles(data.directory, data.files);
          statusMessage.textContent = "";
        })
        .catch(err => {
          filesContainer.innerHTML = `<p style="color:red;">Error fetching file list: ${err}</p>`;
          statusMessage.textContent = "";
        });
    }

    // Build the table of files
    function renderFiles(directory, files) {
      if (!files || files.length === 0) {
        filesContainer.innerHTML = `<p>No files found in <strong>${directory}</strong></p>`;
        return;
      }

      let html = `
        <p>Listing files in <strong>${directory}</strong>:</p>
        <table>
          <thead>
            <tr>
              <th>File Name</th>
              <th>Size (bytes)</th>
              <th>Last Modified</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

      for (const file of files) {
        const encodedName = encodeURIComponent(file.name);
        html += `
          <tr>
            <td>${file.name}</td>
            <td>${file.size}</td>
            <td>${file.modified}</td>
            <td>
              <button onclick="downloadFile('${encodedName}')">Download</button>
              <button onclick="deleteFile('${encodedName}')">Delete</button>
            </td>
          </tr>
        `;
      }

      html += `
          </tbody>
        </table>
      `;

      filesContainer.innerHTML = html;
    }

    // Download a file (opens browser download)
    function downloadFile(encodedName) {
      // We can simply open the /files/download/... URL in a new browser tab
      // or force the browser to download by using an <a> click trick:
      const url = '/files/download/' + encodedName;
      window.open(url, '_blank');
    }

    // Delete a file from the server
    function deleteFile(encodedName) {
      if (!confirm('Are you sure you want to delete this file?')) {
        return;
      }
      statusMessage.textContent = "Deleting file...";

      fetch('/files/delete/' + encodedName, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            alert('Error: ' + data.error);
          } else if (data.success) {
            alert(data.message || "File deleted.");
          }
          // Refresh list
          loadFiles();
        })
        .catch(err => {
          alert("Error deleting file: " + err);
        })
        .finally(() => {
          statusMessage.textContent = "";
        });
    }

    // Auto-load files on page load
    document.addEventListener('DOMContentLoaded', loadFiles);
  </script>
</body>



</body>
</html>
